ltfatstart;

%load signal
[s,Fs]  = audioread('sine400.wav');
s=s(1:220);

T = length(s);
Time = linspace(0,T/Fs,T);

figure;
plot(Time, s);
title('Observed signal');

%induce noise
snrlevel = 10;
sn = awgn(s,snrlevel,'measured');
disp(snr(s,xn));

% sigma_noise = norm(s)^2*10^(-snrlevel/10)/T;
% noise = sqrt(sigma_noise)*randn(size(s));
% xn = s + noise;
% disp(snr(s,sn));

% Gabor parameters: window length, type, overlap
M = 1024;
a = M/2;
g = gabwin({'tight', 'hann'}, a, M);

% Gabor transform
G_sn = dgtreal(sn, g, a, M);
figure;
plotdgtreal(G_sn,a,M,Fs);
title('Gabor coefficients of noisy signal');

lambda = sqrt(sigma_noise);
G_sd = G_sn.*max(0,1-lambda./abs(G_sn));

% WG Lasso

%size of the neighborhood
K = 5; 
neigh = ones(1,K);
neigh = neigh/norm(neigh(:),1);

% center of the window
c = ceil(K/2);

% matrix to stock the local energy of each neighborhood
% centralize gabor squared coefficients, mirror left and right borders

[MG,NG] = size(G_sn);
W = zeros(MG, NG+K-1);
W(:, c: NG+c-1) = abs(G_sd).^2;
W(:, 1:c-1) =  fliplr(W(:, c : 2*(c-1))); % left border
W(:, NG+c:end) = fliplr(W(:, NG - K +2*c: NG+c-1));% right border

% neighborhood energy
W = (conv2(W, neigh, 'same'));
W = W(:, c : NG + c -1);

% thresholding
W = sqrt(W);
G_xd = G_xn.*max(0,1-(lambda./W));

figure;
plotdgtreal(G_xd,a,M,Fs);
title('Gabor coeff. after WGLASSO thresholding');

% snr
xd = idgtreal(G_xd,g,a,M,T);
disp(snr(s,xd));


% ISTA ------- Iterative thresholding

nbit = 30; %number of iteration for ISTA
nb_xp = 30; % number of values for the parameter
lambda_values_it = logspace(-3/4,-2,nb_xp);%generate the vector of parameter

snr_soft_it = zeros(nb_xp,1);
sigma_soft_it = zeros(nb_xp,1);

G_xd = 0.*G_xn;
k=0;